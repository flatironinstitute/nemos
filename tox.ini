[tox]
isolated_build = True
envlist = py,fix,backend-jaxopt,backend-optimistix,jaxopt


[testenv]
# means we'll run the equivalent of `pip install .[dev]`, also installing pytest
# and the linters from pyproject.toml
extras = dev

# Non-interactive backend for doctests
setenv =
    MPLBACKEND = Agg

# Enable package caching
package_cache = .tox/cache

# Run both pytest and coverage since pytest was initialized with the --cov option in the pyproject.toml
# Ignore doctests in src/nemos/third_party (contains JAXopt currently)
commands =
    pytest -n auto --doctest-modules --ignore=src/nemos/third_party  src/nemos/
    pytest -n auto --cov=nemos --cov-config=pyproject.toml --cov-report=xml

[testenv:skip_solver_related]
description = Run all tests except solver-related ones
commands =
    # Run doctests
    pytest -n auto --doctest-modules --ignore=src/nemos/third_party --ignore=src/nemos/solvers src/nemos/

    # Run float32 tests (exclude both solver_related AND requires_x64)
    pytest -n auto -m "not solver_related and not requires_x64" --cov=nemos --cov-config=pyproject.toml --cov-report=xml

    # Run float64 tests separately (include requires_x64, exclude solver_related)
    pytest -n auto -m "requires_x64 and not solver_related" --cov=nemos --cov-config=pyproject.toml --cov-report=xml --cov-append

# Run JAXopt's tests separately
# Note that when run together with NeMoS's tests, some of JAXopt's tests fail
# that otherwise pass. Perhaps the NeMoS tests change some environment variable?
# Also if not separated, if any NeMoS test failed, the following JAXopt tests would not even be started.
[testenv:jaxopt]
description = Run JAXopt's tests
deps = .[jaxopt_dev]
package_cache = .tox/cache
commands =
    pytest -n auto src/nemos/third_party/jaxopt/tests

[testenv:backend-jaxopt]
description = Run solver tests and doctests with the JAXopt backend
setenv =
    NEMOS_SOLVER_BACKEND = jaxopt
commands =
    pytest -n auto --doctest-modules src/nemos/solvers
    pytest -n auto -m solver_related

# -k filters tests based on keyword
[testenv:backend-optimistix]
description = Run solver tests and doctests with the Optimistix backend using both GradientDescent implementations
setenv =
    NEMOS_SOLVER_BACKEND = optimistix
commands =
    {[testenv:backend-jaxopt]commands}
    pytest -n auto --doctest-modules src/nemos/solvers -k OptimistixOptaxGradientDescent -o override_solver=GradientDescent:OptimistixOptaxGradientDescent
    pytest -n auto -m solver_related -k GradientDescent -o override_solver=GradientDescent:OptimistixOptaxGradientDescent

[testenv:fix]
commands=
    black src
    isort src --profile=black
    isort docs/how_to_guide --profile=black
    isort docs/background --profile=black
    isort docs/tutorials --profile=black
    isort docs/scripts --profile=black
    black docs/scripts
    black tests
    isort tests --profile=black
    flake8 --config={toxinidir}/tox.ini src
    flake8 --config={toxinidir}/tox.ini docs/scripts
    ruff check --fix src/nemos
    black scripts
    isort scripts --profile=black
    python scripts/check_parameter_naming.py

[testenv:check]
commands=
    black --check src
    isort --check src --profile=black
    isort --check docs/how_to_guide --profile=black
    isort --check docs/background --profile=black
    isort --check docs/tutorials --profile=black
    isort --check docs/scripts --profile=black
    black --check docs/scripts
    black --check tests
    isort --check tests --profile=black
    flake8 --config={toxinidir}/tox.ini src
    flake8 --config={toxinidir}/tox.ini docs/scripts
    ruff check src/nemos
    black --check scripts
    isort --check scripts --profile=black
    python scripts/check_parameter_naming.py

[gh-actions]
python =
       3.10: py310
       3.11: py311
       3.12: py312


[flake8]
max-complexity = 10
max-line-length = 120
exclude = '''
    ((\.eggs
    | \.git
    | \.hg
    | \.mypy_cache
    | \.md
    | \.toml
    | \.cfg
    | \.txt
    | \.tox
    | \.venv
    | _build
    | buck-out
    | build
    | dist
    | examples
    | src/nemos/third_party/jaxopt
    | __init__.py  # Exclude __init__.py files
    ))'''
extend-ignore = W605, E203, DAR, F722
